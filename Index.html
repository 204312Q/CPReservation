<!doctype html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --good: #e7f7ee;
      --bad: #fdeaea;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap { max-width: 720px; margin: 0 auto; padding: 18px 14px 40px; }
    header {
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 14px;
    }
    .title { line-height: 1.1; }
    .title h1 { font-size: 20px; margin: 0; }
    .title p { margin: 6px 0 0; color: var(--muted); font-size: 13px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 640px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }

    label { display:block; font-size: 13px; color: var(--muted); }
    input, select, textarea, button {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 11px 12px;
      font-size: 14px;
      background: #fff;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #c7d2fe;
      box-shadow: 0 0 0 3px rgba(99,102,241,.15);
    }
    textarea { resize: vertical; min-height: 90px; }

    .row { display:flex; gap: 12px; }
    .row > div { flex: 1; }

    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }

    .actions {
      display:flex;
      gap: 10px;
      margin-top: 14px;
      align-items:center;
    }
    button {
      cursor: pointer;
      font-weight: 600;
      border: none;
      background: #801517;
      color: #fff;
      padding: 12px 14px;
    }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .pill {
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      color: var(--muted);
      font-size: 12px;
    }
    .msg {
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      display:none;
      white-space: pre-wrap;
    }
    .msg.ok { background: var(--good); display:block; }
    .msg.err { background: var(--bad); display:block; }

    .small { font-size: 12px; color: var(--muted); margin-top: 10px; }
    .right { text-align:right; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Book Reservation with us!</h1>
        <p>Choose a date & time, enter pax and contact details.</p>
      </div>
      <div class="pill" id="statusPill">Ready</div>
    </header>

    <div class="card">
      <form id="f" onsubmit="handleSubmit(event)">
        <div class="grid grid-2">
          <div>
            <label>First Name*
              <input name="firstName" required autocomplete="given-name" />
            </label>
          </div>
          <div>
            <label>Last Name*
              <input name="lastName" required autocomplete="family-name" />
            </label>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:12px;">
          <div>
            <label>Phone*
              <input name="phone" required inputmode="tel" autocomplete="tel"
                     placeholder="e.g. 9123 4567" />
            </label>
            <div class="hint">Numbers only recommended.</div>
          </div>
          <div>
            <label>Email
              <input name="email" type="email" autocomplete="email" placeholder="optional" />
            </label>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:12px;">
          <div>
            <label>Date*
              <input name="date" type="date" required onchange="loadTimes()" />
            </label>
          </div>
          <div>
            <label>Time*
              <select name="time" required disabled>
                <option value="">Select a date first</option>
              </select>
            </label>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:12px;">
          <div>
            <label>Adults*
              <input name="adults" type="number" min="1" required value="2" oninput="updateTotal()" />
            </label>
          </div>
          <div>
            <label>Children
              <input name="children" type="number" min="0" value="0" oninput="updateTotal()" />
            </label>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="hint">Total pax: <b id="totalPax">2</b></div>
          <div class="hint right" id="capacityHint"></div>
        </div>

        <div style="margin-top:12px;">
          <label>Additional Request
            <textarea name="notes" rows="3" placeholder="Dietary, stroller, wheelchair, etc."></textarea>
          </label>
        </div>

        <div class="actions">
          <button id="submitBtn" type="submit">Submit Reservation</button>
        </div>

        <div id="msg" class="msg"></div>
        <div class="small">
          By submitting, you confirm the details are correct.
        </div>
      </form>
    </div>
  </div>

  <script>
    const statusPill = document.getElementById('statusPill');
    const msgEl = document.getElementById('msg');
    const timeSel = document.querySelector('[name="time"]');
    const submitBtn = document.getElementById('submitBtn');
    const capacityHint = document.getElementById('capacityHint');

    function setStatus(text) { statusPill.textContent = text; }

    function setMsg(text, ok=true) {
      msgEl.className = 'msg ' + (ok ? 'ok' : 'err');
      msgEl.textContent = text;
    }

    function clearMsg() {
      msgEl.className = 'msg';
      msgEl.textContent = '';
      msgEl.style.display = 'none';
    }

    function updateTotal() {
      const adults = Number(document.querySelector('[name="adults"]').value || 0);
      const children = Number(document.querySelector('[name="children"]').value || 0);
      document.getElementById('totalPax').textContent = adults + children;
    }

    function disableForm(disabled) {
      [...document.querySelectorAll('input, select, textarea, button')].forEach(el => {
        // allow Reset button while sending? up to you — here we disable everything
        el.disabled = disabled;
      });
    }

    function loadTimes() {
      clearMsg();
      setStatus('Loading slots…');
      capacityHint.textContent = '';

      const date = document.querySelector('[name="date"]').value;

      if (!date) {
        timeSel.innerHTML = '<option value="">Select a date first</option>';
        timeSel.disabled = true;
        setStatus('Ready');
        return;
      }

      timeSel.disabled = true;
      timeSel.innerHTML = '<option value="">Loading…</option>';

      google.script.run
        .withSuccessHandler(times => {
          if (!times || times.length === 0) {
            timeSel.innerHTML = '<option value="">No slots available</option>';
            timeSel.disabled = true;
            setStatus('No slots');
            return;
          }

          timeSel.innerHTML =
            '<option value="">Select a time</option>' +
            times.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
          timeSel.disabled = false;
          setStatus('Ready');
        })
        .withFailureHandler(err => {
          setMsg(err.message || String(err), false);
          timeSel.innerHTML = '<option value="">Error loading slots</option>';
          timeSel.disabled = true;
          setStatus('Error');
        })
        .getAvailableTimes(date);
    }

    function basicValidate(data) {
      // phone: allow +, spaces, digits; but must contain at least 8 digits
      const digits = (data.phone || '').replace(/\D/g, '');
      if (digits.length < 8) return 'Phone number looks too short.';

      const adults = Number(data.adults || 0);
      const children = Number(data.children || 0);
      if (adults < 1) return 'Adults must be at least 1.';
      if (children < 0) return 'Children cannot be negative.';
      if (!data.date) return 'Please select a date.';
      if (!data.time) return 'Please select a time.';
      return null;
    }

    function handleSubmit(e) {
      e.preventDefault();
      clearMsg();
      setStatus('Submitting…');

      const f = document.getElementById('f');
      const data = Object.fromEntries(new FormData(f).entries());
      data.adults = Number(data.adults || 0);
      data.children = Number(data.children || 0);

      const err = basicValidate(data);
      if (err) {
        setMsg(err, false);
        setStatus('Fix errors');
        return;
      }

      disableForm(true);

      google.script.run
        .withSuccessHandler(res => {
          const id = res && (res.reservationId || res.id || '');
          setMsg(`Reservation submitted!\nReservation ID: ${id || '(no id returned)'}`, true);
          setStatus('Submitted');
          f.reset();
          timeSel.innerHTML = '<option value="">Select a date first</option>';
          timeSel.disabled = true;
          updateTotal();
          disableForm(false);
        })
        .withFailureHandler(err => {
          setMsg(err.message || String(err), false);
          setStatus('Error');
          disableForm(false);
        })
        .submitReservation(data);
    }
    // Basic XSS-safe escaping for option labels
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // initialize total pax
    updateTotal();
  </script>
</body>
</html>
